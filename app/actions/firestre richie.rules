rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* =========================
       USERS COLLECTION
       ========================= */
    match /users/{userId} {

      // Any authenticated user can read user profiles
      // (for search, add friend, chat, etc)
      allow read: if request.auth != null;

      // User can create ONLY their own document
      // document ID MUST equal auth.uid
      allow create: if request.auth != null
                    && request.auth.uid == userId;

      // User can update ONLY their own document
      allow update: if request.auth != null
                    && request.auth.uid == userId;

      // Optional: allow self-delete only
      allow delete: if request.auth != null
                    && request.auth.uid == userId;
    }
// for numerical
			match /user_numeric_index/{numericId} {
  				allow read: if request.auth != null;
 					allow create: if request.auth != null;
				}

    /* =========================
       CHATS COLLECTION
       ========================= */
    match /chats/{chatId} {

      // Only chat participants can read the chat
      allow read: if request.auth != null
                  && request.auth.uid in resource.data.participants;

      // Only participants can create a chat
      allow create: if request.auth != null
                    && request.auth.uid in request.resource.data.participants;

      // Only participants can update chat (e.g. lastMessage)
      allow update: if request.auth != null
                    && request.auth.uid in resource.data.participants;

      /* =========================
         MESSAGES SUBCOLLECTION
         ========================= */
      match /messages/{messageId} {

        // Only chat participants can read messages
        allow read: if request.auth != null
                    && request.auth.uid in
                       get(/databases/$(database)/documents/chats/$(chatId))
                       .data.participants;

        // Only sender (participant) can send message
        allow create: if request.auth != null
                      && request.auth.uid in
                         get(/databases/$(database)/documents/chats/$(chatId))
                         .data.participants
                      && request.resource.data.senderId == request.auth.uid;

        // Messages cannot be edited or deleted
        allow update, delete: if false;
      }
    }

			

    /* =========================
       DEFAULT DENY
       ========================= */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
